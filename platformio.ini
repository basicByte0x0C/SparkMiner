; SparkMiner - Best of BitsyMiner + NerdMiner
; ESP32 Bitcoin Solo Miner with optimized performance
;
; Build: pio run -e esp32-2432s028
; Upload: pio run -e esp32-2432s028 -t upload
; Monitor: pio device monitor

[platformio]
default_envs = esp32-2432s028

[env]
platform = espressif32@6.6.0
framework = arduino
monitor_speed = 115200
monitor_eol = CRLF
monitor_echo = yes
monitor_filters =
    esp32_exception_decoder
    time
    log2file

extra_scripts =
    post:scripts/post_build_merge.py

lib_deps =
    bblanchon/ArduinoJson@^6.21.5
    https://github.com/tzapu/WiFiManager.git#v2.0.17
    mathertel/OneButton@^2.5.0
    arduino-libraries/NTPClient@^3.2.1

; ============================================================
; ESP32-2432S028R - "Cheap Yellow Display" 2.8" ILI9341
; This is the standard CYD with ILI9341 driver
; Uses PIPELINED ASSEMBLY SHA-256 for ~600+ KH/s (BitsyMiner-style)
; ============================================================
[env:esp32-2432s028]
board = esp32dev
board_build.partitions = huge_app.csv
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D ESP32_2432S028=1
    ; Hardware SHA-256 via direct register access to SHA peripheral
    -D HARDWARE_SHA256=1
    -D USE_DISPLAY=1
    ; Optimization: O1 to fit in IRAM with display libraries
    -O1
    ; ===== TFT_eSPI Configuration =====
    ; CRITICAL: This tells TFT_eSPI to use these build flags instead of User_Setup.h
    -D USER_SETUP_LOADED=1
    ; Driver - ILI9341_2_DRIVER is the alternative driver that works better on CYD
    -D ILI9341_2_DRIVER=1
    ; Display dimensions (in portrait mode, library handles rotation)
    -D TFT_WIDTH=240
    -D TFT_HEIGHT=320
    ; Color inversion - required for correct colors on CYD
    -D TFT_INVERSION_ON=1
    ; SPI Pins - CYD uses HSPI
    -D TFT_MOSI=13
    -D TFT_SCLK=14
    -D TFT_CS=15
    -D TFT_DC=2
    -D TFT_RST=12
    ; Backlight
    -D TFT_BL=21
    -D TFT_BACKLIGHT_ON=HIGH
    ; SPI Frequencies
    -D SPI_FREQUENCY=55000000
    -D SPI_READ_FREQUENCY=20000000
    ; Fonts to load
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    ; ===== Board Hardware =====
    ; RGB LED pins (active low)
    -D LED_R_PIN=4
    -D LED_G_PIN=16
    -D LED_B_PIN=17
    ; Button
    -D BUTTON_PIN=0
    ; SD card pins (CYD onboard slot)
    -D SD_CS_PIN=5
    ; Debug (uncomment to enable)
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    https://github.com/takkaO/OpenFontRender#v1.2
    bodmer/TFT_eSPI@^2.5.43
    SD

; ============================================================
; ESP32-2432S028R - ST7789 variant (some CYDs use ST7789)
; Try this if the ILI9341 version shows garbled display
; Uses PIPELINED ASSEMBLY SHA-256 for ~600+ KH/s (BitsyMiner-style)
; ============================================================
[env:esp32-2432s028-st7789]
board = esp32dev
board_build.partitions = huge_app.csv
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D ESP32_2432S028=1
    ; Hardware SHA-256 via direct register access to SHA peripheral
    -D HARDWARE_SHA256=1
    -D USE_DISPLAY=1
    ; Optimization: O1 to fit in IRAM with display libraries
    -O1
    ; ===== TFT_eSPI Configuration =====
    -D USER_SETUP_LOADED=1
    ; ST7789 driver for variant boards
    -D ILI9341_2_DRIVER=1
    -D TFT_WIDTH=240
    -D TFT_HEIGHT=320
    -D TFT_INVERSION_ON=1
    ; SPI Pins - same as ILI9341 variant
    -D TFT_MOSI=13
    -D TFT_SCLK=14
    -D TFT_CS=15
    -D TFT_DC=2
    -D TFT_RST=12
    -D TFT_BL=21
    -D TFT_BACKLIGHT_ON=HIGH
    -D SPI_FREQUENCY=55000000
    -D SPI_READ_FREQUENCY=20000000
    ; Fonts
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    ; Board hardware
    -D LED_R_PIN=4
    -D LED_G_PIN=16
    -D LED_B_PIN=17
    -D BUTTON_PIN=0
    ; SD card
    -D SD_CS_PIN=5
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    https://github.com/takkaO/OpenFontRender#v1.2
    bodmer/TFT_eSPI@^2.5.43
    SD

; ============================================================
; ESP32-2432S028 2USB variant (has 2 USB ports, different backlight)
; Uses PIPELINED ASSEMBLY SHA-256 for ~600+ KH/s (BitsyMiner-style)
; ============================================================
[env:esp32-2432s028-2usb]
board = esp32dev
board_build.partitions = huge_app.csv
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D ESP32_2432S028=1
    ; Hardware SHA-256 via direct register access to SHA peripheral
    -D HARDWARE_SHA256=1
    -D USE_DISPLAY=1
    ; Optimization: O1 to fit in IRAM with display libraries
    -O1
    ; TFT_eSPI Configuration
    -D USER_SETUP_LOADED=1
    -D ILI9341_2_DRIVER=1
    -D TFT_WIDTH=240
    -D TFT_HEIGHT=320
    -D TFT_INVERSION_ON=1
    -D TFT_MOSI=13
    -D TFT_SCLK=14
    -D TFT_CS=15
    -D TFT_DC=2
    -D TFT_RST=12
    -D TFT_BL=21
    -D TFT_BACKLIGHT_ON=HIGH
    -D SPI_FREQUENCY=55000000
    -D SPI_READ_FREQUENCY=20000000
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    ; Board hardware
    -D LED_R_PIN=4
    -D LED_G_PIN=16
    -D LED_B_PIN=17
    -D BUTTON_PIN=0
    ; SD card
    -D SD_CS_PIN=5
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    https://github.com/takkaO/OpenFontRender#v1.2
    bodmer/TFT_eSPI@^2.5.43
    SD

; ============================================================
; ESP32-S3-2432S028 - 2.8" ST7789 (Single USB-C)
; S3 version of CYD with ST7789 display and different pinout
; ============================================================
[env:esp32-s3-2432s028]
board = esp32-s3-devkitc-1
board_build.partitions = default_8MB.csv
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
upload_speed = 921600
build_type = debug

build_unflags = -Os

build_flags =
    -D ESP32_S3_CYD=1
    -D USE_HARDWARE_SHA=1
    -D DEBUG_MINING=1
    ; -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=1
    ; Optimization
    -O3
    -funroll-loops
    ; Display
    -D USE_DISPLAY=1
    ; ===== TFT_eSPI Configuration =====
    -D USER_SETUP_LOADED=1
    -D ILI9341_2_DRIVER=1
    -D TFT_WIDTH=240
    -D TFT_HEIGHT=320
    -D TFT_INVERSION_ON=1
    ; SPI Pins (Freenove FNK0104 ESP32-S3 Display)
    -D TFT_MOSI=11
    -D TFT_SCLK=12
    -D TFT_CS=10
    -D TFT_DC=46
    -D TFT_RST=-1
    -D TFT_BL=45
    -D TFT_BACKLIGHT_ON=HIGH
    -D SPI_FREQUENCY=27000000
    -D SPI_READ_FREQUENCY=20000000
    ; Fonts
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    ; Board hardware
    -D LED_PIN=4
    -D BUTTON_PIN=0
    ; SD Card (SD_MMC 4-bit interface - Freenove FNK0104)
    -D USE_SD_MMC=1
    -D SD_MMC_CLK=38
    -D SD_MMC_CMD=40
    -D SD_MMC_D0=39
    -D SD_MMC_D1=41
    -D SD_MMC_D2=48
    -D SD_MMC_D3=47
    -D BOARD_MAX_SDMMC_FREQ=4000
    ; Touch Pins (CST328 I2C)
    -D TOUCH_SDA=1
    -D TOUCH_SCL=3
    -D TOUCH_RST=2
    -D TOUCH_INT=4
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    https://github.com/takkaO/OpenFontRender#v1.2
    bodmer/TFT_eSPI@^2.5.43
    SD_MMC

; ============================================================
; LILYGO T-Display S3 - 170x320 ST7789 (8-bit parallel)
; Most popular modern ESP32 board with built-in display
; ============================================================
[env:lilygo-t-display-s3]
board = lilygo-t-display-s3
board_build.partitions = default_16MB.csv
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D LILYGO_T_DISPLAY_S3=1
    -D USE_HARDWARE_SHA=1
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_MODE=1
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D USE_DISPLAY=1
    ; Optimization
    -O2
    ; ===== TFT_eSPI Configuration (8-bit parallel) =====
    -D USER_SETUP_LOADED=1
    -D ST7789_DRIVER=1
    -D INIT_SEQUENCE_3=1
    -D CGRAM_OFFSET=1
    -D TFT_RGB_ORDER=TFT_RGB
    -D TFT_INVERSION_ON=1
    -D TFT_PARALLEL_8_BIT=1
    -D TFT_WIDTH=170
    -D TFT_HEIGHT=320
    ; Parallel data bus pins
    -D TFT_D0=39
    -D TFT_D1=40
    -D TFT_D2=41
    -D TFT_D3=42
    -D TFT_D4=45
    -D TFT_D5=46
    -D TFT_D6=47
    -D TFT_D7=48
    ; Control pins
    -D TFT_CS=6
    -D TFT_DC=7
    -D TFT_RST=5
    -D TFT_WR=8
    -D TFT_RD=9
    -D TFT_BL=38
    -D TFT_BACKLIGHT_ON=HIGH
    ; Fonts
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    ; Buttons
    -D BUTTON_PIN=0
    -D BUTTON2_PIN=14
    ; 5V power enable
    -D PIN_ENABLE5V=15
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    https://github.com/takkaO/OpenFontRender#v1.2
    bodmer/TFT_eSPI@^2.5.43

lib_ignore =
    SD
    SD_MMC

; ============================================================
; LILYGO T-Display V1 - 135x240 ST7789 (SPI)
; Classic T-Display with ESP32 and small display
; ============================================================
[env:lilygo-t-display-v1]
board = esp32dev
board_build.partitions = huge_app.csv
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D LILYGO_T_DISPLAY_V1=1
    -D USE_HARDWARE_SHA=1
    -D USE_DISPLAY=1
    ; Optimization
    -O1
    ; ===== TFT_eSPI Configuration (SPI) =====
    -D USER_SETUP_LOADED=1
    -D ST7789_DRIVER=1
    -D TFT_SDA_READ=1
    -D CGRAM_OFFSET=1
    -D TFT_WIDTH=135
    -D TFT_HEIGHT=240
    ; SPI pins
    -D TFT_MOSI=19
    -D TFT_SCLK=18
    -D TFT_CS=5
    -D TFT_DC=16
    -D TFT_RST=23
    -D TFT_BL=4
    -D TFT_BACKLIGHT_ON=HIGH
    ; SPI speed
    -D SPI_FREQUENCY=40000000
    -D SPI_READ_FREQUENCY=6000000
    ; Fonts
    -D LOAD_GLCD=1
    -D LOAD_FONT2=1
    -D LOAD_FONT4=1
    -D LOAD_GFXFF=1
    -D SMOOTH_FONT=1
    ; Buttons
    -D BUTTON_PIN=0
    -D BUTTON2_PIN=35
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    https://github.com/takkaO/OpenFontRender#v1.2
    bodmer/TFT_eSPI@^2.5.43

lib_ignore =
    SD
    SD_MMC

; ============================================================
; ESP32-S3 DevKit - Hardware SHA acceleration (headless)
; ============================================================
[env:esp32-s3-devkit]
board = esp32-s3-devkitc-1
board_build.partitions = default_8MB.csv
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D ESP32_S3_DEVKIT=1
    -D USE_HARDWARE_SHA=1
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=1
    ; Optimization
    -O3
    -funroll-loops
    ; No display - headless mode
    -D USE_DISPLAY=0
    ; Built-in LED
    -D LED_PIN=48
    ; Button
    -D BUTTON_PIN=0
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    SD

lib_ignore =
    TFT_eSPI
    OpenFontRender

; ============================================================
; ESP32 Headless - No display, serial only
; Uses HARDWARE SHA-256 for maximum performance!
; ============================================================
[env:esp32-headless]
board = esp32dev
board_build.partitions = huge_app.csv
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D ESP32_HEADLESS=1
    -D USE_HARDWARE_SHA=1
    -D USE_DISPLAY=0
    -D BUTTON_PIN=0
    ; Optimization - headless can use O3
    -O3
    -funroll-loops
    ;-D DEBUG_MINING=1

lib_ignore =
    TFT_eSPI
    OpenFontRender
    SD
    SD_MMC

; ============================================================
; ESP32-S3 Mini (Wemos/Lolin) - Headless with RGB LED
; Built-in WS2812B on GPIO47 for status indication
; ============================================================
[env:esp32-s3-mini]
board = lolin_s3_mini
board_build.partitions = huge_app.csv
board_build.arduino.memory_type = qio_opi
upload_speed = 115200

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D ESP32_S3_MINI=1
    -D USE_HARDWARE_SHA=1
    -D BOARD_HAS_PSRAM
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=1
    -D USE_DISPLAY=0
    ; RGB LED status feedback
    -D USE_LED_STATUS=1
    -D RGB_LED_PIN=47
    -D RGB_LED_TYPE_WS2812B=1
    -D RGB_LED_BRIGHTNESS=32
    ; Optimization
    -O3
    -funroll-loops
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    fastled/FastLED@3.7.8

lib_ignore =
    TFT_eSPI
    OpenFontRender
    SD
    SD_MMC

; ============================================================
; ESP32 Headless with external RGB LED (NeoPixel)
; For users who want LED status feedback on generic ESP32
; Connect WS2812B data to GPIO2 (or configure RGB_LED_PIN)
; ============================================================
[env:esp32-headless-led]
board = esp32dev
board_build.partitions = huge_app.csv
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D ESP32_HEADLESS_LED=1
    -D USE_HARDWARE_SHA=1
    -D USE_DISPLAY=0
    ; RGB LED status feedback
    -D USE_LED_STATUS=1
    -D RGB_LED_PIN=2
    -D RGB_LED_TYPE_WS2812B=1
    -D RGB_LED_BRIGHTNESS=32
    -D BUTTON_PIN=0
    ; Optimization
    -O3
    -funroll-loops
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}
    fastled/FastLED@3.7.8

lib_ignore =
    TFT_eSPI
    OpenFontRender
    SD
    SD_MMC

; ============================================================
; ESP32-C3 SuperMini - Single-core RISC-V (headless)
; Ultra-compact and cheap, single miner task only
; ============================================================
[env:esp32-c3-supermini]
board = seeed_xiao_esp32c3
board_build.partitions = default.csv
board_build.mcu = esp32c3
board_build.f_cpu = 160000000L
upload_speed = 921600

build_unflags = -Os

build_flags =
    -D AUTO_VERSION=\"v2.8.0\"
    -D ESP32_C3_SUPERMINI=1
    ; Software SHA (RISC-V has no Xtensa assembly)
    -D USE_SOFTWARE_SHA=1
    -D USE_DISPLAY=0
    -D BUTTON_PIN=9
    ; Optimization for single-core
    -O2
    ;-D DEBUG_MINING=1

lib_deps =
    ${env.lib_deps}

lib_ignore =
    TFT_eSPI
    OpenFontRender
    SD
    SD_MMC
    FastLED
